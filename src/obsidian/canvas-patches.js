import { randomHexString } from "../utils";
/**
 * Minimum width for new notes
 */
const minWidth = 360;
/**
 * Assumed pixel width per character
 */
const pxPerChar = 5;
/**
 * Assumed pixel height per line
 */
const pxPerLine = 28;
/**
 * Assumed height of top + bottom text area padding
 */
const textPaddingHeight = 12;
/**
 * Margin between new notes
 */
const newNoteMargin = 60;
const newNoteMarginWithLabel = 110;
/**
 * Min height of new notes
 */
const minHeight = 60;
/**
 * Choose height for generated note based on text length and parent height.
 * For notes beyond a few lines, the note will have scroll bar.
 * Not a precise science, just something that is not surprising.
 */
// export const calcHeight = (options: { parentHeight: number; text: string }) => {
export const calcHeight = (options) => {
    const calcTextHeight = Math.round(textPaddingHeight +
        (pxPerLine * options.text.length) / (minWidth / pxPerChar));
    return calcTextHeight;
    // return Math.max(options.parentHeight, calcTextHeight);
};
const DEFAULT_NODE_WIDTH = 400;
const DEFAULT_NODE_HEIGHT = DEFAULT_NODE_WIDTH * (1024 / 1792) + 20;
/**
 * Create new node as descendant from the parent node.
 * Align and offset relative to siblings.
 */
export const createNode = (canvas, nodeOptions, parentNode, nodeData, edgeLabel) => {
    var _a, _b;
    if (!canvas) {
        throw new Error("Invalid arguments");
    }
    const { text } = nodeOptions;
    const width = parentNode
        ? ((_a = nodeOptions === null || nodeOptions === void 0 ? void 0 : nodeOptions.size) === null || _a === void 0 ? void 0 : _a.width) || Math.max(minWidth, parentNode === null || parentNode === void 0 ? void 0 : parentNode.width)
        : DEFAULT_NODE_WIDTH;
    const height = text
        ? parentNode
            ? ((_b = nodeOptions === null || nodeOptions === void 0 ? void 0 : nodeOptions.size) === null || _b === void 0 ? void 0 : _b.height) ||
                Math.max(minHeight, parentNode &&
                    calcHeight({
                        text,
                        // parentHeight: parentNode.height
                    }))
            : DEFAULT_NODE_HEIGHT
        : undefined;
    // @ts-expect-error
    let x = canvas.x - width / 2;
    // @ts-expect-error
    let y = canvas.y - height / 2;
    if (parentNode) {
        const siblings = parent &&
            canvas
                .getEdgesForNode(parentNode)
                .filter((n) => n.from.node.id == parentNode.id)
                .map((e) => e.to.node);
        // Failsafe leftmost value.
        const farLeft = parentNode.y - parentNode.width * 5;
        const siblingsRight = (siblings === null || siblings === void 0 ? void 0 : siblings.length)
            ? siblings.reduce((right, sib) => Math.max(right, sib.x + sib.width), farLeft)
            : undefined;
        const priorSibling = siblings[siblings.length - 1];
        // Position left at right of prior sibling, otherwise aligned with parent
        x =
            siblingsRight != null
                ? siblingsRight + newNoteMargin
                : parentNode.x;
        // Position top at prior sibling top, otherwise offset below parent
        y =
            (priorSibling
                ? priorSibling.y
                : parentNode.y +
                    parentNode.height +
                    (edgeLabel ? newNoteMarginWithLabel : newNoteMargin)) +
                // Using position=left, y value is treated as vertical center
                height * 0.5;
    }
    const newNode = nodeOptions.type === "file"
        ? //  @ts-expect-error
            canvas.createFileNode({
                file: nodeOptions.file,
                pos: { x, y },
                // // position: "left",
                // size: { height, width },
                // focus: false,
            })
        : canvas.createTextNode({
            pos: { x, y },
            position: "left",
            size: { height, width },
            text,
            focus: false,
        });
    if (nodeData) {
        newNode.setData(nodeData);
    }
    canvas.deselectAll();
    canvas.addNode(newNode);
    if (parentNode) {
        addEdge(canvas, randomHexString(16), {
            fromOrTo: "from",
            side: "bottom",
            node: parentNode,
        }, {
            fromOrTo: "to",
            side: "top",
            node: newNode,
        }, edgeLabel, {
            isGenerated: true,
        });
    }
    return newNode;
};
/**
 * Add edge entry to canvas.
 */
export const addEdge = (canvas, edgeID, fromEdge, toEdge, label, edgeData) => {
    if (!canvas)
        return;
    const data = canvas.getData();
    if (!data)
        return;
    canvas.importData({
        edges: [
            ...data.edges,
            Object.assign(Object.assign({}, edgeData), { id: edgeID, fromNode: fromEdge.node.id, fromSide: fromEdge.side, toNode: toEdge.node.id, toSide: toEdge.side, label }),
        ],
        nodes: data.nodes,
    });
    canvas.requestFrame();
};
/**
 * Trap exception and write to console.error.
 */
export function trapError(fn) {
    return (...params) => {
        try {
            return fn(...params);
        }
        catch (e) {
            console.error(e);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLXBhdGNoZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjYW52YXMtcGF0Y2hlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBaUIzQzs7R0FFRztBQUNILE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQztBQUVyQjs7R0FFRztBQUNILE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQUVwQjs7R0FFRztBQUNILE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztBQUVyQjs7R0FFRztBQUNILE1BQU0saUJBQWlCLEdBQUcsRUFBRSxDQUFDO0FBRTdCOztHQUVHO0FBQ0gsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLE1BQU0sc0JBQXNCLEdBQUcsR0FBRyxDQUFDO0FBRW5DOztHQUVHO0FBQ0gsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBRXJCOzs7O0dBSUc7QUFDSCxtRkFBbUY7QUFDbkYsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFHLENBQUMsT0FBeUIsRUFBRSxFQUFFO0lBQ3ZELE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQ2hDLGlCQUFpQjtRQUNoQixDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQyxDQUMzRCxDQUFDO0lBQ0YsT0FBTyxjQUFjLENBQUM7SUFDdEIseURBQXlEO0FBQzFELENBQUMsQ0FBQztBQUVGLE1BQU0sa0JBQWtCLEdBQUcsR0FBRyxDQUFDO0FBQy9CLE1BQU0sbUJBQW1CLEdBQUcsa0JBQWtCLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBRXBFOzs7R0FHRztBQUNILE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRyxDQUN6QixNQUFjLEVBQ2QsV0FBOEIsRUFDOUIsVUFBdUIsRUFDdkIsUUFB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ZCxRQUVDLEVBQ0EsRUFBRTtJQUNILElBQUksQ0FBQyxNQUFNO1FBQUUsT0FBTztJQUVwQixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7SUFFOUIsSUFBSSxDQUFDLElBQUk7UUFBRSxPQUFPO0lBRWxCLE1BQU0sQ0FBQyxVQUFVLENBQUM7UUFDakIsS0FBSyxFQUFFO1lBQ04sR0FBRyxJQUFJLENBQUMsS0FBSzs0Q0FFVCxRQUFRLEtBQ1gsRUFBRSxFQUFFLE1BQU0sRUFDVixRQUFRLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQzFCLFFBQVEsRUFBRSxRQUFRLENBQUMsSUFBSSxFQUN2QixNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQ3RCLE1BQU0sRUFBRSxNQUFNLENBQUMsSUFBSSxFQUNuQixLQUFLO1NBRU47UUFDRCxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7S0FDakIsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDO0FBQ3ZCLENBQUMsQ0FBQztBQUVGOztHQUVHO0FBQ0gsTUFBTSxVQUFVLFNBQVMsQ0FBSSxFQUErQjtJQUMzRCxPQUFPLENBQUMsR0FBRyxNQUFpQixFQUFFLEVBQUU7UUFDL0IsSUFBSTtZQUNILE9BQU8sRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUM7U0FDckI7UUFBQyxPQUFPLENBQUMsRUFBRTtZQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDakI7SUFDRixDQUFDLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSXRlbVZpZXcgfSBmcm9tIFwib2JzaWRpYW5cIjtcbmltcG9ydCB7IEFsbENhbnZhc05vZGVEYXRhIH0gZnJvbSBcIm9ic2lkaWFuL2NhbnZhc1wiO1xuaW1wb3J0IHsgcmFuZG9tSGV4U3RyaW5nIH0gZnJvbSBcIi4uL3V0aWxzXCI7XG5pbXBvcnQgeyBDYW52YXMsIENhbnZhc05vZGUsIENyZWF0ZU5vZGVPcHRpb25zIH0gZnJvbSBcIi4vY2FudmFzLWludGVybmFsXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FudmFzRWRnZUludGVybWVkaWF0ZSB7XG5cdGZyb21PclRvOiBzdHJpbmc7XG5cdHNpZGU6IHN0cmluZztcblx0bm9kZTogQ2FudmFzRWxlbWVudDtcbn1cblxuaW50ZXJmYWNlIENhbnZhc0VsZW1lbnQge1xuXHRpZDogc3RyaW5nO1xufVxuXG5leHBvcnQgdHlwZSBDYW52YXNWaWV3ID0gSXRlbVZpZXcgJiB7XG5cdGNhbnZhczogQ2FudmFzO1xufTtcblxuLyoqXG4gKiBNaW5pbXVtIHdpZHRoIGZvciBuZXcgbm90ZXNcbiAqL1xuY29uc3QgbWluV2lkdGggPSAzNjA7XG5cbi8qKlxuICogQXNzdW1lZCBwaXhlbCB3aWR0aCBwZXIgY2hhcmFjdGVyXG4gKi9cbmNvbnN0IHB4UGVyQ2hhciA9IDU7XG5cbi8qKlxuICogQXNzdW1lZCBwaXhlbCBoZWlnaHQgcGVyIGxpbmVcbiAqL1xuY29uc3QgcHhQZXJMaW5lID0gMjg7XG5cbi8qKlxuICogQXNzdW1lZCBoZWlnaHQgb2YgdG9wICsgYm90dG9tIHRleHQgYXJlYSBwYWRkaW5nXG4gKi9cbmNvbnN0IHRleHRQYWRkaW5nSGVpZ2h0ID0gMTI7XG5cbi8qKlxuICogTWFyZ2luIGJldHdlZW4gbmV3IG5vdGVzXG4gKi9cbmNvbnN0IG5ld05vdGVNYXJnaW4gPSA2MDtcbmNvbnN0IG5ld05vdGVNYXJnaW5XaXRoTGFiZWwgPSAxMTA7XG5cbi8qKlxuICogTWluIGhlaWdodCBvZiBuZXcgbm90ZXNcbiAqL1xuY29uc3QgbWluSGVpZ2h0ID0gNjA7XG5cbi8qKlxuICogQ2hvb3NlIGhlaWdodCBmb3IgZ2VuZXJhdGVkIG5vdGUgYmFzZWQgb24gdGV4dCBsZW5ndGggYW5kIHBhcmVudCBoZWlnaHQuXG4gKiBGb3Igbm90ZXMgYmV5b25kIGEgZmV3IGxpbmVzLCB0aGUgbm90ZSB3aWxsIGhhdmUgc2Nyb2xsIGJhci5cbiAqIE5vdCBhIHByZWNpc2Ugc2NpZW5jZSwganVzdCBzb21ldGhpbmcgdGhhdCBpcyBub3Qgc3VycHJpc2luZy5cbiAqL1xuLy8gZXhwb3J0IGNvbnN0IGNhbGNIZWlnaHQgPSAob3B0aW9uczogeyBwYXJlbnRIZWlnaHQ6IG51bWJlcjsgdGV4dDogc3RyaW5nIH0pID0+IHtcbmV4cG9ydCBjb25zdCBjYWxjSGVpZ2h0ID0gKG9wdGlvbnM6IHsgdGV4dDogc3RyaW5nIH0pID0+IHtcblx0Y29uc3QgY2FsY1RleHRIZWlnaHQgPSBNYXRoLnJvdW5kKFxuXHRcdHRleHRQYWRkaW5nSGVpZ2h0ICtcblx0XHRcdChweFBlckxpbmUgKiBvcHRpb25zLnRleHQubGVuZ3RoKSAvIChtaW5XaWR0aCAvIHB4UGVyQ2hhcilcblx0KTtcblx0cmV0dXJuIGNhbGNUZXh0SGVpZ2h0O1xuXHQvLyByZXR1cm4gTWF0aC5tYXgob3B0aW9ucy5wYXJlbnRIZWlnaHQsIGNhbGNUZXh0SGVpZ2h0KTtcbn07XG5cbmNvbnN0IERFRkFVTFRfTk9ERV9XSURUSCA9IDQwMDtcbmNvbnN0IERFRkFVTFRfTk9ERV9IRUlHSFQgPSBERUZBVUxUX05PREVfV0lEVEggKiAoMTAyNCAvIDE3OTIpICsgMjA7XG5cbi8qKlxuICogQ3JlYXRlIG5ldyBub2RlIGFzIGRlc2NlbmRhbnQgZnJvbSB0aGUgcGFyZW50IG5vZGUuXG4gKiBBbGlnbiBhbmQgb2Zmc2V0IHJlbGF0aXZlIHRvIHNpYmxpbmdzLlxuICovXG5leHBvcnQgY29uc3QgY3JlYXRlTm9kZSA9IChcblx0Y2FudmFzOiBDYW52YXMsXG5cdG5vZGVPcHRpb25zOiBDcmVhdGVOb2RlT3B0aW9ucyxcblx0cGFyZW50Tm9kZT86IENhbnZhc05vZGUsXG5cdG5vZGVEYXRhPzogUGFydGlhbDxBbGxDYW52YXNOb2RlRGF0YT4sXG5cdGVkZ2VMYWJlbD86IHN0cmluZ1xuKSA9PiB7XG5cdGlmICghY2FudmFzKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBhcmd1bWVudHNcIik7XG5cdH1cblxuXHRjb25zdCB7IHRleHQgfSA9IG5vZGVPcHRpb25zO1xuXG5cdGNvbnN0IHdpZHRoID0gcGFyZW50Tm9kZVxuXHRcdD8gbm9kZU9wdGlvbnM/LnNpemU/LndpZHRoIHx8IE1hdGgubWF4KG1pbldpZHRoLCBwYXJlbnROb2RlPy53aWR0aClcblx0XHQ6IERFRkFVTFRfTk9ERV9XSURUSDtcblxuXHRjb25zdCBoZWlnaHQgPSB0ZXh0XG5cdFx0PyBwYXJlbnROb2RlXG5cdFx0XHQ/IG5vZGVPcHRpb25zPy5zaXplPy5oZWlnaHQgfHxcblx0XHRcdCAgTWF0aC5tYXgoXG5cdFx0XHRcdFx0bWluSGVpZ2h0LFxuXHRcdFx0XHRcdHBhcmVudE5vZGUgJiZcblx0XHRcdFx0XHRcdGNhbGNIZWlnaHQoe1xuXHRcdFx0XHRcdFx0XHR0ZXh0LFxuXHRcdFx0XHRcdFx0XHQvLyBwYXJlbnRIZWlnaHQ6IHBhcmVudE5vZGUuaGVpZ2h0XG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0ICApXG5cdFx0XHQ6IERFRkFVTFRfTk9ERV9IRUlHSFRcblx0XHQ6IHVuZGVmaW5lZDtcblxuXHQvLyBAdHMtZXhwZWN0LWVycm9yXG5cdGxldCB4ID0gY2FudmFzLnggLSB3aWR0aCAvIDI7XG5cdC8vIEB0cy1leHBlY3QtZXJyb3Jcblx0bGV0IHkgPSBjYW52YXMueSAtIGhlaWdodCAvIDI7XG5cblx0aWYgKHBhcmVudE5vZGUpIHtcblx0XHRjb25zdCBzaWJsaW5ncyA9XG5cdFx0XHRwYXJlbnQgJiZcblx0XHRcdGNhbnZhc1xuXHRcdFx0XHQuZ2V0RWRnZXNGb3JOb2RlKHBhcmVudE5vZGUpXG5cdFx0XHRcdC5maWx0ZXIoKG4pID0+IG4uZnJvbS5ub2RlLmlkID09IHBhcmVudE5vZGUuaWQpXG5cdFx0XHRcdC5tYXAoKGUpID0+IGUudG8ubm9kZSk7XG5cblx0XHQvLyBGYWlsc2FmZSBsZWZ0bW9zdCB2YWx1ZS5cblx0XHRjb25zdCBmYXJMZWZ0ID0gcGFyZW50Tm9kZS55IC0gcGFyZW50Tm9kZS53aWR0aCAqIDU7XG5cdFx0Y29uc3Qgc2libGluZ3NSaWdodCA9IHNpYmxpbmdzPy5sZW5ndGhcblx0XHRcdD8gc2libGluZ3MucmVkdWNlKFxuXHRcdFx0XHRcdChyaWdodCwgc2liKSA9PiBNYXRoLm1heChyaWdodCwgc2liLnggKyBzaWIud2lkdGgpLFxuXHRcdFx0XHRcdGZhckxlZnRcblx0XHRcdCAgKVxuXHRcdFx0OiB1bmRlZmluZWQ7XG5cdFx0Y29uc3QgcHJpb3JTaWJsaW5nID0gc2libGluZ3Nbc2libGluZ3MubGVuZ3RoIC0gMV07XG5cblx0XHQvLyBQb3NpdGlvbiBsZWZ0IGF0IHJpZ2h0IG9mIHByaW9yIHNpYmxpbmcsIG90aGVyd2lzZSBhbGlnbmVkIHdpdGggcGFyZW50XG5cdFx0eCA9XG5cdFx0XHRzaWJsaW5nc1JpZ2h0ICE9IG51bGxcblx0XHRcdFx0PyBzaWJsaW5nc1JpZ2h0ICsgbmV3Tm90ZU1hcmdpblxuXHRcdFx0XHQ6IHBhcmVudE5vZGUueDtcblxuXHRcdC8vIFBvc2l0aW9uIHRvcCBhdCBwcmlvciBzaWJsaW5nIHRvcCwgb3RoZXJ3aXNlIG9mZnNldCBiZWxvdyBwYXJlbnRcblx0XHR5ID1cblx0XHRcdChwcmlvclNpYmxpbmdcblx0XHRcdFx0PyBwcmlvclNpYmxpbmcueVxuXHRcdFx0XHQ6IHBhcmVudE5vZGUueSArXG5cdFx0XHRcdCAgcGFyZW50Tm9kZS5oZWlnaHQgK1xuXHRcdFx0XHQgIChlZGdlTGFiZWwgPyBuZXdOb3RlTWFyZ2luV2l0aExhYmVsIDogbmV3Tm90ZU1hcmdpbikpICtcblx0XHRcdC8vIFVzaW5nIHBvc2l0aW9uPWxlZnQsIHkgdmFsdWUgaXMgdHJlYXRlZCBhcyB2ZXJ0aWNhbCBjZW50ZXJcblx0XHRcdGhlaWdodCEgKiAwLjU7XG5cdH1cblxuXHRjb25zdCBuZXdOb2RlID1cblx0XHRub2RlT3B0aW9ucy50eXBlID09PSBcImZpbGVcIlxuXHRcdFx0PyAvLyAgQHRzLWV4cGVjdC1lcnJvclxuXHRcdFx0ICBjYW52YXMuY3JlYXRlRmlsZU5vZGUoe1xuXHRcdFx0XHRcdGZpbGU6IG5vZGVPcHRpb25zLmZpbGUsXG5cdFx0XHRcdFx0cG9zOiB7IHgsIHkgfSxcblx0XHRcdFx0XHQvLyAvLyBwb3NpdGlvbjogXCJsZWZ0XCIsXG5cdFx0XHRcdFx0Ly8gc2l6ZTogeyBoZWlnaHQsIHdpZHRoIH0sXG5cdFx0XHRcdFx0Ly8gZm9jdXM6IGZhbHNlLFxuXHRcdFx0ICB9KVxuXHRcdFx0OiBjYW52YXMuY3JlYXRlVGV4dE5vZGUoe1xuXHRcdFx0XHRcdHBvczogeyB4LCB5IH0sXG5cdFx0XHRcdFx0cG9zaXRpb246IFwibGVmdFwiLFxuXHRcdFx0XHRcdHNpemU6IHsgaGVpZ2h0LCB3aWR0aCB9LFxuXHRcdFx0XHRcdHRleHQsXG5cdFx0XHRcdFx0Zm9jdXM6IGZhbHNlLFxuXHRcdFx0ICB9KTtcblxuXHRpZiAobm9kZURhdGEpIHtcblx0XHRuZXdOb2RlLnNldERhdGEobm9kZURhdGEpO1xuXHR9XG5cblx0Y2FudmFzLmRlc2VsZWN0QWxsKCk7XG5cdGNhbnZhcy5hZGROb2RlKG5ld05vZGUpO1xuXG5cdGlmIChwYXJlbnROb2RlKSB7XG5cdFx0YWRkRWRnZShcblx0XHRcdGNhbnZhcyxcblx0XHRcdHJhbmRvbUhleFN0cmluZygxNiksXG5cdFx0XHR7XG5cdFx0XHRcdGZyb21PclRvOiBcImZyb21cIixcblx0XHRcdFx0c2lkZTogXCJib3R0b21cIixcblx0XHRcdFx0bm9kZTogcGFyZW50Tm9kZSxcblx0XHRcdH0sXG5cdFx0XHR7XG5cdFx0XHRcdGZyb21PclRvOiBcInRvXCIsXG5cdFx0XHRcdHNpZGU6IFwidG9wXCIsXG5cdFx0XHRcdG5vZGU6IG5ld05vZGUsXG5cdFx0XHR9LFxuXHRcdFx0ZWRnZUxhYmVsLFxuXHRcdFx0e1xuXHRcdFx0XHRpc0dlbmVyYXRlZDogdHJ1ZSxcblx0XHRcdH1cblx0XHQpO1xuXHR9XG5cblx0cmV0dXJuIG5ld05vZGU7XG59O1xuXG4vKipcbiAqIEFkZCBlZGdlIGVudHJ5IHRvIGNhbnZhcy5cbiAqL1xuZXhwb3J0IGNvbnN0IGFkZEVkZ2UgPSAoXG5cdGNhbnZhczogQ2FudmFzLFxuXHRlZGdlSUQ6IHN0cmluZyxcblx0ZnJvbUVkZ2U6IENhbnZhc0VkZ2VJbnRlcm1lZGlhdGUsXG5cdHRvRWRnZTogQ2FudmFzRWRnZUludGVybWVkaWF0ZSxcblx0bGFiZWw/OiBzdHJpbmcsXG5cdGVkZ2VEYXRhPzoge1xuXHRcdGlzR2VuZXJhdGVkOiBib29sZWFuO1xuXHR9XG4pID0+IHtcblx0aWYgKCFjYW52YXMpIHJldHVybjtcblxuXHRjb25zdCBkYXRhID0gY2FudmFzLmdldERhdGEoKTtcblxuXHRpZiAoIWRhdGEpIHJldHVybjtcblxuXHRjYW52YXMuaW1wb3J0RGF0YSh7XG5cdFx0ZWRnZXM6IFtcblx0XHRcdC4uLmRhdGEuZWRnZXMsXG5cdFx0XHR7XG5cdFx0XHRcdC4uLmVkZ2VEYXRhLFxuXHRcdFx0XHRpZDogZWRnZUlELFxuXHRcdFx0XHRmcm9tTm9kZTogZnJvbUVkZ2Uubm9kZS5pZCxcblx0XHRcdFx0ZnJvbVNpZGU6IGZyb21FZGdlLnNpZGUsXG5cdFx0XHRcdHRvTm9kZTogdG9FZGdlLm5vZGUuaWQsXG5cdFx0XHRcdHRvU2lkZTogdG9FZGdlLnNpZGUsXG5cdFx0XHRcdGxhYmVsLFxuXHRcdFx0fSxcblx0XHRdLFxuXHRcdG5vZGVzOiBkYXRhLm5vZGVzLFxuXHR9KTtcblxuXHRjYW52YXMucmVxdWVzdEZyYW1lKCk7XG59O1xuXG4vKipcbiAqIFRyYXAgZXhjZXB0aW9uIGFuZCB3cml0ZSB0byBjb25zb2xlLmVycm9yLlxuICovXG5leHBvcnQgZnVuY3Rpb24gdHJhcEVycm9yPFQ+KGZuOiAoLi4ucGFyYW1zOiB1bmtub3duW10pID0+IFQpIHtcblx0cmV0dXJuICguLi5wYXJhbXM6IHVua25vd25bXSkgPT4ge1xuXHRcdHRyeSB7XG5cdFx0XHRyZXR1cm4gZm4oLi4ucGFyYW1zKTtcblx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRjb25zb2xlLmVycm9yKGUpO1xuXHRcdH1cblx0fTtcbn1cbiJdfQ==